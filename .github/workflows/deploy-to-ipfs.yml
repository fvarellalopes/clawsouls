name: Deploy to IPFS (Storacha)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
          
      - name: Build static export
        run: npm run build
        
      - name: Check build output
        run: |
          echo "=== Root dir ==="
          ls -la
          echo ""
          echo "=== .next dir ==="
          ls -la .next/ 2>/dev/null || echo ".next not found"
          echo ""
          echo "=== dist dir ==="
          ls -la dist/ 2>/dev/null || echo "dist not found"
          echo ""
          echo "=== out dir ==="
          ls -la out/ 2>/dev/null || echo "out not found"
          
      - name: Set output directory
        id: set-output
        run: |
          if [ -d "dist" ]; then
            echo "dir=dist" >> $GITHUB_OUTPUT
          elif [ -d "out" ]; then
            echo "dir=out" >> $GITHUB_OUTPUT  
          else
            echo "dir=.next" >> $GITHUB_OUTPUT
          fi
          echo "Output dir: ${{ steps.set-output.outputs.dir }}"
          
      - name: Deploy to IPFS via Storacha
        id: deploy
        uses: ipshipyard/ipfs-deploy-action@v1.8.0
        with:
          path-to-deploy: ${{ steps.set-output.outputs.dir }}
          storacha-key: ${{ secrets.STORACHA_KEY }}
          storacha-proof: ${{ secrets.STORACHA_PROOF }}
          pinata-jwt-token: ${{ secrets.PINATA_JWT }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Output deployment info
        run: |
          echo "‚úÖ Deployment complete!"
          echo "IPFS CID: ${{ steps.deploy.outputs.cid }}"
          echo ""
          echo "üîó Access your site:"
          echo "  - Gateway: https://ipfs.io/ipfs/${{ steps.deploy.outputs.cid }}"
          echo "  - Storacha: https://w3s.link/ipfs/${{ steps.deploy.outputs.cid }}"
          echo "  - Dweb: https://dweb.link/ipfs/${{ steps.deploy.outputs.cid }}"
          
      - name: Save CID to file
        run: echo "${{ steps.deploy.outputs.cid }}" > cid.txt
          
      - name: Upload CID artifact
        uses: actions/upload-artifact@v4
        with:
          name: ipfs-cid-${{ github.run_id }}
          path: cid.txt
          retention-days: 30
          
      - name: Update deployment badge on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the logs above for details."
